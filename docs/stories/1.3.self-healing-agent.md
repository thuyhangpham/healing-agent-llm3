# Story 1.3: Self-Healing Agent

## Status
Approved

## Goals and Background Context

### Goals
- Implement a self-healing agent that can automatically detect, analyze, and repair web scraping failures using local LLM integration
- Achieve Mean Time To Repair (MTTR) of under 60 seconds for self-healing operations
- Achieve >80% self-repair success rate for detected failures
- Provide empirical validation of AI system robustness in volatile data environments
- Enable real-time sentiment analysis of legal policy discussions from multiple sources

### Background Context
Current policy sentiment analysis systems operate on batch processing mechanisms and are highly unstable in real-time scenarios. The core problem is that data sources (online newspapers, government portals) frequently change their interface structures (HTML/CSS drift), causing traditional scrapers and crawlers to crash. This results in data interruptions and significant manual maintenance costs.

There is a research gap in empirical studies on robustness and self-healing capabilities of AI systems for sentiment monitoring in volatile data environments. This project addresses this gap by building a self-adaptive multi-agent system that can automatically detect web structure errors, use LLMs to rewrite data collection code, and automatically redeploy without human intervention.

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-14 | 1.0 | Initial story creation | BMad Master |

## Requirements

### Functional Requirements
1. **FR1:** The system shall continuously monitor and collect data from multiple legal data sources (government portals, online newspapers) 24/7 without manual intervention.
2. **FR2:** The system shall automatically detect web structure changes and interface failures (HTML/CSS drift) that cause data collection errors.
3. **FR3:** The Healing Agent shall analyze error contexts (traceback, failed file path, HTML snapshot) and generate corrective Python code using local LLM (Ollama/Llama 3).
4. **FR4:** The system shall perform syntax validation and sandbox testing of AI-generated fixes before deployment.
5. **FR5:** The system shall implement hot-reload functionality to deploy fixes without shutting down the main program using importlib.reload().
6. **FR6:** The system shall create automatic backups (.bak files) before applying any code patches.
7. **FR7:** The system shall extract and analyze sentiment from collected legal texts and opinion articles using LLM-based sentiment analysis.
8. **FR8:** The system shall process PDF and document formats from legal sources through AutonomousPdfAnalysisAgent.
9. **FR9:** The Orchestrator Agent shall coordinate workflow execution and maintain global state across all worker agents.
10. **FR10:** The system shall log all self-healing activities, errors, and repair attempts for empirical analysis.

### Non-Functional Requirements
1. **NFR1:** The system shall achieve a Mean Time To Repair (MTTR) of under 60 seconds for self-healing operations.

## User Interface Design Goals

### Overall UX Vision
The system requires a simple command-line interface and basic logging for researchers to observe self-healing operations and analyze empirical data. The interface should prioritize functionality over visual design, focusing on core self-healing agent validation and data collection.

### Key Interaction Paradigms
- **Command-line interface** with simple status commands and log output
- **File-based logging** for all self-healing operations and metrics
- **Simple configuration files** for agent parameters and healing settings
- **Basic data export** to CSV/JSON for external analysis tools
- **Basic monitoring scripts** for system health checks

### Core Interface Components
- **CLI Status Commands** - Simple commands to check agent status and healing operations
- **Structured Log Files** - Comprehensive logging of all healing events and system operations
- **Configuration Files** - YAML/JSON files for system settings and agent parameters
- **Data Export Scripts** - Simple scripts to export metrics and research data
- **Basic Monitoring Scripts** - Shell/Python scripts for system health checks

### Accessibility
Command-line interface accessible via standard terminal/shell environments.

### Branding
Minimal interface design focused on functionality and research data integrity.

### Target Device and Platforms
Command-line interface compatible with Linux, macOS, and Windows terminals.

## Technical Assumptions

### Repository Structure: Simple Project Structure
Single directory containing core agents, healing components, and basic utilities with minimal complexity.

### Service Architecture
**Focused Multi-Agent System with Self-Healing Core** - Built with simplified Python architecture:
- **Core Agent Layer**: Basic agent framework with error handling
- **Worker Agent Layer**: Essential data collection agents with error-catching mechanisms
- **Self-Healing Layer**: Healing Agent with automated code repair capabilities
- **Infrastructure Layer**: Local LLM (Ollama/Llama 3), basic code patching, file-based logging

### Testing Requirements
**Focused Testing on Self-Healing Core** - Unit tests for healing agent functionality, basic integration tests for agent coordination, and simple validation testing for MTTR and success rate metrics.

### Additional Technical Assumptions and Requests
**Core Technology Stack:**
- **Framework**: Simplified Python-based agent framework (minimal external dependencies)
- **AI Model**: Ollama (Llama 3) running locally for zero-cost operations
- **Web Scraping**: BeautifulSoup4 and requests for basic data collection
- **Code Processing**: Python with Importlib for hot-reload capabilities
- **Data Storage**: JSON and CSV files for data processing and storage
- **Monitoring**: File-based logging and simple CLI status commands

### Deployment Requirements
- **Local PC deployment** with Ollama installed (GPU optional but recommended)
- **Hot-reload capability** using importlib.reload() without system shutdown
- **Simple backup system** for code files before patching
- **Basic validation** for testing AI-generated fixes before deployment

### Performance Targets
- **MTTR < 60 seconds** for self-healing operations
- **>80% success rate** for automated repairs
- **Continuous operation** with minimal manual intervention
- **Error detection** and healing initiation
- **File export capabilities** for research data and analysis

### Research and Validation Requirements
- **File-based logging** of all healing events for empirical analysis
- **Simple fault injection** for basic validation testing
- **Basic metrics collection** for MTTR and success rate analysis
- **File export capabilities** for research data and analysis

## Epic List

### Epic 1: Core Multi-Agent System & Data Collection
**Epic Goal:** Establish foundational project infrastructure with LangGraph framework integration, basic agent orchestration capabilities, and initial monitoring system. This epic delivers a working multi-agent system with health monitoring that validates the core architecture and provides a deployable foundation for subsequent development.

### Epic 2: Self-Healing Innovation & AI-Powered Repair
Build core innovation - Healing Agent with LLM integration, automated code analysis, patch generation, and hot-reload capabilities to achieve MTTR <60s and >80% success rate.

### Epic 3: Research Validation & Empirical Analysis
Implement chaos engineering, comprehensive metrics collection, sentiment analysis pipeline, and research analytics to validate self-healing claims for academic publication.

## Epic 1: Core Multi-Agent System & Data Collection
**Epic Goal:** Establish foundational project infrastructure with LangGraph framework integration, basic agent orchestration capabilities, and initial monitoring system. This epic delivers a working multi-agent system with health monitoring that validates the core architecture and provides a deployable foundation for subsequent development.

## Tasks / Subtasks

### Task 1.1: Self-Healing Agent Core Implementation
- [x] Create healing_agent.py extending BaseAgent
- [x] Implement LLM integration for code analysis and generation
- [x] Add error context capture (traceback, HTML snapshots, file paths)
- [x] Implement code validation and sandbox testing
- [x] Add hot-reload functionality for runtime fixes
- [x] Create backup and rollback mechanisms
- [x] Implement metrics collection for MTTR and success rates

### Task 1.2: LLM Integration and Code Generation
- [x] Create llm_client.py for Ollama/Llama 3 integration
- [x] Implement prompt engineering for code repair
- [x] Add code extraction and validation from LLM responses
- [x] Implement temperature and token management for consistent output

### Task 1.3: Error Detection and Analysis
- [x] Implement web scraping error detection mechanisms
- [x] Add HTML/CSS drift detection
- [x] Create error categorization and prioritization
- [x] Implement failure pattern analysis and learning
- [x] Add error context enrichment for better LLM understanding

### Task 1.4: Hot-Reload and Runtime Patching
- [x] Implement importlib.reload() for code hot-swapping
- [x] Create code patch application without system shutdown
- [x] Add patch validation and rollback capabilities
- [x] Implement concurrent operation during patching

### Task 1.5: Metrics Collection and Analysis
- [x] Create healing_metrics.py for comprehensive metrics tracking
- [x] Implement MTTR calculation and reporting
- [x] Add success rate analysis and trend detection
- [x] Create research data export for empirical validation
- [x] Implement chaos engineering testing framework

### Task 1.6: Configuration and Deployment
- [x] Create healing.yaml configuration file
- [x] Add CLI commands for healing system management
- [x] Implement local deployment scripts
- [x] Add system health monitoring and alerting
- [x] Create documentation and user guides

### Task 1.7: Testing and Validation
- [x] Create comprehensive unit tests for healing agent
- [x] Add integration tests with orchestrator and worker agents
- [x] Implement fault injection testing for validation
- [x] Add performance benchmarking and load testing
- [x] Create end-to-end workflow validation tests

### Task 1.8: Documentation and Research
- [x] Document healing agent architecture and design decisions
- [x] Create user guides and API documentation
- [x] Implement research data collection and analysis tools
- [x] Add academic publication preparation framework

## Dev Agent Record

### Agent Model Used
- Model: James (dev)
- Session Date: 2024-12-14

### Debug Log References
- All healing system components implemented with comprehensive error handling
- LLM integration with Ollama/Llama 3 for code analysis and generation
- Hot-reload functionality with backup and rollback mechanisms
- Comprehensive metrics collection for MTTR and success rate tracking
- Chaos engineering framework for resilience testing
- Research data export capabilities for empirical validation

### Completion Notes
- Successfully implemented complete self-healing agent system
- All core components functional and integrated
- Performance targets: MTTR < 60s, Success Rate > 80%
- Comprehensive testing suite created
- Research validation framework implemented
- CLI management tools provided

### Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-12-14 | 1.0 | Complete self-healing agent implementation | James (dev) |

### File List
- agents/healing_agent.py - Core healing agent with LLM integration
- core/llm_client.py - Ollama client for code generation
- core/error_detector.py - Error detection and analysis system
- core/code_patcher.py - Hot-reload and code patching system
- core/healing_metrics.py - Comprehensive metrics collection
- core/chaos_engineering.py - Chaos testing framework
- healing/validator.py - Code validation and security checking
- core/research_exporter.py - Research data export for empirical validation
- config/healing.yaml - Complete healing system configuration
- config/agents.yaml - Agent configuration with healing integration
- scripts/healing_status.py - CLI monitoring and status tools
- scripts/deploy_healing.py - Deployment and setup scripts
- scripts/export_data.py - Data export utilities
- tests/test_healing_comprehensive.py - Comprehensive unit tests
- tests/test_healing_integration.py - Integration tests

### Status
Ready for Review